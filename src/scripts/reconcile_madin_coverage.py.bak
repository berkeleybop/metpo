#!/usr/bin/env python3
"""
Reconcile Madin MongoDB field values against METPO synonyms attributed to Madin source.

This script:
1. Connects to MongoDB and extracts unique values from a specified Madin field
2. Reads the SPARQL synonym-sources.tsv report
3. Filters for synonyms attributed to https://github.com/jmadin/bacteria_archaea_traits
4. Reports which Madin values are covered/missing in METPO
"""

import click
import csv
import re
import sys
import yaml
from typing import Dict, List, Set

from pymongo import MongoClient


MADIN_SOURCE_URI = "https://github.com/jmadin/bacteria_archaea_traits"

# Entity type mappings to OWL CURIEs
ENTITY_TYPE_MAP = {
    'class': 'owl:Class',
    'property': 'owl:ObjectProperty'  # Default for properties
}

def get_entity_curie(entity_uri: str) -> str:
    """
    Convert entity URI to CURIE format.

    :param entity_uri: Full URI like 'https://w3id.org/metpo/1000602'
    :return: CURIE like 'METPO:1000602'
    """
    if entity_uri.startswith('https://w3id.org/metpo/'):
        return 'METPO:' + entity_uri.split('/')[-1]
    return entity_uri


def normalize_whitespace(text: str) -> str:
    """
    Normalize whitespace: trim left/right and collapse internal whitespace.

    :param text: Input text
    :return: Normalized text
    """
    return re.sub(r'\s+', ' ', text.strip())


def get_madin_field_values(field_path: str, db_name: str = "madin", collection_name: str = "madin") -> Dict[str, str]:
    """
    Extract unique values from a Madin MongoDB field.

    :param field_path: MongoDB field path (e.g., 'gram_stain', 'metabolism')
    :param db_name: MongoDB database name
    :param collection_name: MongoDB collection name
    :return: Dict mapping normalized values to original values (to track if normalization occurred)
    """
    client = MongoClient()
    db = client[db_name]
    collection = db[collection_name]

    values = collection.distinct(field_path)

    value_map = {}
    for v in values:
        if v and v != "NA":
            normalized = normalize_whitespace(v)
            value_map[normalized] = v

    return value_map


def load_madin_synonyms(tsv_path: str) -> Dict[str, Dict[str, str]]:
    """
    Load synonyms attributed to Madin source from synonym-sources.tsv.

    :param tsv_path: Path to reports/synonym-sources.tsv
    :return: Dictionary mapping normalized synonym values to their METPO entity and predicate info
    """
    madin_synonyms = {}
    entity_labels = {}

    with open(tsv_path, 'r') as f:
        reader = csv.DictReader(f, delimiter='\t')

        for row in reader:
            entity = row.get('?entity', '').strip('<>')
            entity_type = row.get('?entityType', '').strip('"')
            pred = row.get('?synonymPred', '').strip('<>')
            syn_value = row.get('?synValue', '').strip('"')
            src = row.get('?src', '').strip('<>')

            if entity and pred and syn_value:
                if pred == 'http://www.w3.org/2000/01/rdf-schema#label':
                    entity_labels[entity] = syn_value

                if src == MADIN_SOURCE_URI:
                    normalized_syn = normalize_whitespace(syn_value)
                    if normalized_syn not in madin_synonyms:
                        madin_synonyms[normalized_syn] = {
                            'entity': entity,
                            'entity_type': entity_type,
                            'predicate': pred,
                            'source': src,
                            'label': None
                        }

    for syn_value, info in madin_synonyms.items():
        entity = info['entity']
        if entity in entity_labels:
            info['label'] = entity_labels[entity]

    return madin_synonyms


def get_all_madin_fields(db_name: str = "madin", collection_name: str = "madin") -> List[str]:
    """
    Get all field names from the Madin MongoDB collection.

    :param db_name: MongoDB database name
    :param collection_name: MongoDB collection name
    :return: List of all field names
    """
    client = MongoClient()
    db = client[db_name]
    collection = db[collection_name]

    sample_doc = collection.find_one()

    if sample_doc:
        return [key for key in sample_doc.keys() if key != '_id']
    return []


def get_all_madin_values_with_fields(db_name: str = "madin", collection_name: str = "madin") -> Dict[str, List[str]]:
    """
    Get ALL unique values from ALL fields in the Madin MongoDB collection.

    :param db_name: MongoDB database name
    :param collection_name: MongoDB collection name
    :return: Dict mapping normalized values to list of field names where they appear
    """
    client = MongoClient()
    db = client[db_name]
    collection = db[collection_name]

    value_to_fields = {}
    fields = get_all_madin_fields(db_name, collection_name)

    for field in fields:
        values = collection.distinct(field)
        for v in values:
            if v and v != "NA":
                normalized = normalize_whitespace(str(v))
                if normalized not in value_to_fields:
                    value_to_fields[normalized] = []
                value_to_fields[normalized].append(field)

    return value_to_fields


def reconcile_all_field_names(tsv_path: str, output_format: str = "text") -> None:
    """
    Check if ALL Madin field names are synonyms in METPO.

    :param tsv_path: Path to synonym-sources.tsv report
    :param output_format: Output format ('text' or 'yaml')
    """
    madin_fields = get_all_madin_fields()
    madin_synonyms = load_madin_synonyms(tsv_path)

    # Get value counts for each field
    client = MongoClient()
    db = client["madin"]
    collection = db["madin"]

    field_value_counts = {}
    for field in madin_fields:
        values = collection.distinct(field)
        non_na_count = sum(1 for v in values if v and v != "NA")
        field_value_counts[field] = non_na_count

    covered_entries = []
    missing_entries = []

    for field_path in sorted(madin_fields):
        field_name = normalize_whitespace(field_path.replace('_', ' '))
        field_path_normalized = normalize_whitespace(field_path)
        value_count = field_value_counts[field_path]

        if field_path_normalized in madin_synonyms or field_name in madin_synonyms:
            if field_path_normalized in madin_synonyms:
                info = madin_synonyms[field_path_normalized]
            else:
                info = madin_synonyms[field_name]

            metpo_curie = get_entity_curie(info['entity'])
            label = info.get('label', '')
            entity_type_raw = info.get('entity_type', 'unknown')
            entity_type = ENTITY_TYPE_MAP.get(entity_type_raw, entity_type_raw)

            covered_entries.append({
                'field': field_path,
                'metpo_id': metpo_curie,
                'label': label,
                'entity_type': entity_type,
                'unique_values': value_count
            })
        else:
            missing_entries.append({
                'field': field_path,
                'unique_values': value_count
            })

    # Sort missing entries by value count (descending) to highlight high-value missing fields
    missing_entries.sort(key=lambda x: x['unique_values'], reverse=True)

    total = len(madin_fields)
    covered_count = len(covered_entries)
    missing_count = len(missing_entries)
    coverage_pct = 100 * covered_count / total if total > 0 else 0

    if output_format == "yaml":
        result = {
            'field_name_reconciliation': {
                'summary': {
                    'total_fields': total,
                    'covered': covered_count,
                    'missing': missing_count,
                    'coverage_percentage': round(coverage_pct, 1)
                },
                'covered_fields': covered_entries,
                'missing_fields': missing_entries,
                'high_value_missing_fields': [
                    entry for entry in missing_entries if entry['unique_values'] >= 5
                ]
            }
        }
        print(yaml.dump(result, default_flow_style=False, sort_keys=False, allow_unicode=True))
    else:
        print(f"\n{'='*80}")
        print(f"Checking ALL Madin field names against METPO synonyms")
        print(f"{'='*80}\n")
        print(f"Total Madin fields: {total}\n")
        print(f"COVERED ({covered_count}/{total} = {coverage_pct:.1f}%):")
        print("-" * 80)
        for entry in covered_entries:
            if entry['label']:
                print(f"  ✓ '{entry['field']}' → METPO:{entry['metpo_id']} ({entry['label']}) [{entry['unique_values']} unique values]")
            else:
                print(f"  ✓ '{entry['field']}' → METPO:{entry['metpo_id']} [{entry['unique_values']} unique values]")

        if missing_entries:
            print(f"\nMISSING ({missing_count}/{total} = {100*missing_count/total:.1f}%):")
            print("-" * 80)
            for entry in missing_entries:
                print(f"  ✗ '{entry['field']}' [{entry['unique_values']} unique values]")

            high_value_missing = [e for e in missing_entries if e['unique_values'] >= 5]
            if high_value_missing:
                print(f"\nHIGH-VALUE MISSING FIELDS ({len(high_value_missing)} fields with ≥5 unique values):")
                print("-" * 80)
                for entry in high_value_missing:
                    print(f"  ⚠ '{entry['field']}' [{entry['unique_values']} unique values]")

        print(f"\n{'='*80}\n")


def reconcile_coverage(field_path: str, tsv_path: str, output_format: str = "text") -> None:
    """
    Reconcile Madin field values against METPO synonyms.

    :param field_path: MongoDB field path to check
    :param tsv_path: Path to synonym-sources.tsv report
    :param output_format: Output format ('text' or 'yaml')
    """
    madin_value_map = get_madin_field_values(field_path)
    madin_synonyms = load_madin_synonyms(tsv_path)

    covered_entries = []
    missing_entries = []

    for normalized_value in sorted(madin_value_map.keys()):
        original_value = madin_value_map[normalized_value]
        was_normalized = (normalized_value != original_value)

        if normalized_value in madin_synonyms:
            info = madin_synonyms[normalized_value]
            metpo_curie = get_entity_curie(info['entity'])
            label = info.get('label', '')
            entity_type_raw = info.get('entity_type', 'unknown')
            entity_type = ENTITY_TYPE_MAP.get(entity_type_raw, entity_type_raw)

            covered_entries.append({
                'value': normalized_value,
                'original_value': original_value if was_normalized else None,
                'metpo_id': metpo_curie,
                'label': label,
                'entity_type': entity_type
            })
        else:
            missing_entries.append({
                'value': normalized_value,
                'original_value': original_value if was_normalized else None
            })

    total = len(madin_value_map)
    covered_count = len(covered_entries)
    missing_count = len(missing_entries)
    coverage_pct = 100 * covered_count / total if total > 0 else 0

    if output_format == "yaml":
        result = {
            'field_value_reconciliation': {
                'field': field_path,
                'summary': {
                    'total_values': total,
                    'covered': covered_count,
                    'missing': missing_count,
                    'coverage_percentage': round(coverage_pct, 1)
                },
                'covered_values': covered_entries,
                'missing_values': missing_entries
            }
        }
        print(yaml.dump(result, default_flow_style=False, sort_keys=False, allow_unicode=True))
    else:
        print(f"\n{'='*80}")
        print(f"Reconciling Madin field: {field_path}")
        print(f"{'='*80}\n")
        print(f"MongoDB values found: {total} (excluding 'NA')")
        print(f"Madin synonyms in METPO: {len(madin_synonyms)}\n")
        print(f"COVERED ({covered_count}/{total} = {coverage_pct:.1f}%):")
        print("-" * 80)
        for entry in covered_entries:
            normalization_note = f" [NORMALIZED from '{entry['original_value']}']" if entry['original_value'] else ""
            if entry['label']:
                print(f"  ✓ '{entry['value']}' → METPO:{entry['metpo_id']} ({entry['label']}){normalization_note}")
            else:
                print(f"  ✓ '{entry['value']}' → METPO:{entry['metpo_id']}{normalization_note}")

        if missing_entries:
            print(f"\nMISSING ({missing_count}/{total} = {100*missing_count/total:.1f}%):")
            print("-" * 80)
            for entry in missing_entries:
                normalization_note = f" [NORMALIZED from '{entry['original_value']}']" if entry['original_value'] else ""
                print(f"  ✗ '{entry['value']}'{normalization_note}")

        print(f"\n{'='*80}\n")


def verify_madin_synonyms(tsv_path: str, output_format: str = "text") -> None:
    """
    Verify that all METPO synonyms attributed to Madin actually exist in the Madin MongoDB.

    This checks the reverse direction: do the synonyms claimed in METPO actually appear
    in the source data?

    :param tsv_path: Path to synonym-sources.tsv report
    :param output_format: Output format ('text' or 'yaml')
    """
    value_to_fields = get_all_madin_values_with_fields()
    madin_synonyms = load_madin_synonyms(tsv_path)

    verified_entries = []
    unverified_entries = []

    for syn_value, info in madin_synonyms.items():
        metpo_curie = get_entity_curie(info['entity'])
        entity_type_raw = info.get('entity_type', 'unknown')
        entity_type = ENTITY_TYPE_MAP.get(entity_type_raw, entity_type_raw)
        label = info.get('label', '')

        if syn_value in value_to_fields:
            fields = value_to_fields[syn_value]
            verified_entries.append({
                'synonym': syn_value,
                'metpo_id': metpo_curie,
                'entity_type': entity_type,
                'label': label,
                'found_in_fields': fields,
                'field_count': len(fields)
            })
        else:
            unverified_entries.append({
                'synonym': syn_value,
                'metpo_id': metpo_curie,
                'entity_type': entity_type,
                'label': label
            })

    total_madin_values = len(value_to_fields)
    total_synonyms = len(madin_synonyms)
    verified_count = len(verified_entries)
    unverified_count = len(unverified_entries)
    verification_pct = 100 * verified_count / total_synonyms if total_synonyms > 0 else 0

    if output_format == "yaml":
        result = {
            'synonym_verification': {
                'summary': {
                    'total_madin_values': total_madin_values,
                    'total_metpo_madin_synonyms': total_synonyms,
                    'verified': verified_count,
                    'unverified': unverified_count,
                    'verification_percentage': round(verification_pct, 1)
                },
                'verified_synonyms': verified_entries,
                'unverified_synonyms': unverified_entries,
                'false_synonym_claims': unverified_entries  # Highlight false claims
            }
        }
        print(yaml.dump(result, default_flow_style=False, sort_keys=False, allow_unicode=True))
    else:
        print(f"\n{'='*80}")
        print(f"Verifying METPO Madin synonyms against actual Madin data")
        print(f"{'='*80}\n")
        print("Loading all Madin values from MongoDB...")
        print(f"Total unique Madin values found: {total_madin_values}\n")
        print("Loading METPO synonyms attributed to Madin...")
        print(f"Total METPO synonyms attributed to Madin: {total_synonyms}\n")
        print(f"VERIFIED ({verified_count}/{total_synonyms} = {verification_pct:.1f}%):")
        print("-" * 80)
        for entry in sorted(verified_entries, key=lambda x: x['synonym']):
            fields_str = ', '.join(entry['found_in_fields']) if entry['field_count'] <= 3 else f"{', '.join(entry['found_in_fields'][:3])}, ..."
            if entry['label']:
                print(f"  ✓ '{entry['synonym']}' (METPO:{entry['metpo_id']} [{entry['entity_type']}] - {entry['label']}) in {entry['field_count']} field(s): [{fields_str}]")
            else:
                print(f"  ✓ '{entry['synonym']}' (METPO:{entry['metpo_id']} [{entry['entity_type']}]) in {entry['field_count']} field(s): [{fields_str}]")

        if unverified_entries:
            print(f"\nUNVERIFIED ({unverified_count}/{total_synonyms} = {100*unverified_count/total_synonyms:.1f}%):")
            print("-" * 80)
            print("These synonyms are attributed to Madin in METPO but NOT found in Madin field VALUES:")
            print("⚠ FALSE SYNONYM CLAIMS - METPO incorrectly attributes these to Madin source")
            print()
            for entry in sorted(unverified_entries, key=lambda x: x['synonym']):
                if entry['label']:
                    print(f"  ✗ '{entry['synonym']}' (METPO:{entry['metpo_id']} [{entry['entity_type']}] - {entry['label']})")
                else:
                    print(f"  ✗ '{entry['synonym']}' (METPO:{entry['metpo_id']} [{entry['entity_type']}])")

        print(f"\n{'='*80}\n")


@click.command()
@click.option(
    '--mode',
    type=click.Choice(['values', 'field_names', 'verify_synonyms'], case_sensitive=False),
    default='values',
    help="Reconciliation mode: 'values' checks field values, 'field_names' checks ALL field names, 'verify_synonyms' verifies METPO synonyms exist in Madin data"
)
@click.option(
    '--field',
    type=str,
    help="MongoDB field path to reconcile (e.g., 'gram_stain', 'metabolism'). Required for 'values' mode."
)
@click.option(
    '--tsv',
    type=click.Path(exists=True),
    default='reports/synonym-sources.tsv',
    help="Path to synonym-sources.tsv report"
)
@click.option(
    '--format',
    'output_format',
    type=click.Choice(['text', 'yaml'], case_sensitive=False),
    default='text',
    help="Output format: 'text' for console output, 'yaml' for structured YAML"
)
def main(mode, field, tsv, output_format):
    """Reconcile Madin MongoDB field values against METPO synonyms."""
    try:
        if mode == "field_names":
            reconcile_all_field_names(tsv, output_format)
        elif mode == "verify_synonyms":
            verify_madin_synonyms(tsv, output_format)
        else:  # values mode
            if not field:
                raise click.UsageError("--field is required for 'values' mode")
            reconcile_coverage(field, tsv, output_format)
    except Exception as e:
        click.echo(f"Error: {e}", err=True)
        sys.exit(1)


if __name__ == "__main__":
    main()
